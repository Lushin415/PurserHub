# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤

## –ë–∞–≥ #1: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π ConversationHandler –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –Ω–∞—Å—Ç—Ä–æ–π–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ü–í–ó, –≤–≤—ë–ª –Ω–µ–≤–µ—Ä–Ω—É—é –¥–∞—Ç—É, –ø–æ–ª—É—á–∏–ª –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
–ù–µ –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞" ‚Äî –∞ –ø–µ—Ä–µ—à—ë–ª –≤ —Ä–∞–∑–¥–µ–ª "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å" —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫—É.
–í—ã–±—Ä–∞–ª Avito/Cian, –ø–æ–ª—É—á–∏–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ —Å—Å—ã–ª–∫–∏. –í–≤—ë–ª —Å—Å—ã–ª–∫—É ‚Äî –ø—Ä–∏—à–ª–∞ –æ—à–∏–±–∫–∞
"–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã" (—ç—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç ConversationHandler –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ü–í–ó, –∞ –Ω–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏).
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ Avito/Cian "–∑–∞–≤–∏—Å–ª–æ", –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
–í python-telegram-bot **–Ω–µ—Å–∫–æ–ª—å–∫–æ ConversationHandler –º–æ–≥—É—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
–¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ö–∞–∂–¥—ã–π ConversationHandler –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

**–ü–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (bot.py:147-154):**
1. `register_start_handlers` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ reply-–∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
2. `register_auth_handlers` ‚Äî auth ConversationHandler
3. `register_settings_handlers`
4. `register_subscription_handlers`
5. `register_workers_handlers` ‚Äî workers ConversationHandler
6. `register_realty_handlers` ‚Äî realty ConversationHandler
7. `register_blacklist_handlers` ‚Äî blacklist ConversationHandler

**–°—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞:**
1. Workers conv –∞–∫—Ç–∏–≤–µ–Ω (—Å–æ—Å—Ç–æ—è–Ω–∏–µ `INPUT_DATE_TO`), –∂–¥—ë—Ç —Ç–µ–∫—Å—Ç
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç inline-–∫–Ω–æ–ø–∫—É "Avito" ‚Üí callback –ù–ï –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è workers conv
   (–≤ states —Ç–æ–ª—å–∫–æ `MessageHandler`, –∞ –Ω–µ `CallbackQueryHandler`)
3. Realty conv –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ entry_point ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ `INPUT_URL`, –∂–¥—ë—Ç —Ç–µ–∫—Å—Ç
4. **–¢–µ–ø–µ—Ä—å –û–ë–ê conv –∞–∫—Ç–∏–≤–Ω—ã –∏ –∂–¥—É—Ç —Ç–µ–∫—Å—Ç!**
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫—É Avito ‚Üí workers conv (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω—å—à–µ) –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç
   –∫–∞–∫ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞—Ç—ã ‚Üí –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
6. Realty conv –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –≤–≤–æ–¥ ‚Üí "–∑–∞–≤–∏—Å–∞–µ—Ç"

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ ConversationHandler

| –§–∞–π–ª | Conv | –°–æ—Å—Ç–æ—è–Ω–∏—è —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –≤–≤–æ–¥–æ–º |
|------|------|------------------------------|
| `handlers/auth.py` | auth_conv | `WAITING_PHONE`, `WAITING_CODE`, `WAITING_2FA` |
| `handlers/workers.py` | monitoring_conv | `INPUT_DATE_FROM`, `INPUT_DATE_TO`, `INPUT_MIN_PRICE`, `INPUT_MAX_PRICE` |
| `handlers/realty.py` | parsing_conv | `INPUT_URL` |
| `handlers/blacklist.py` | check_user_conv | `WAITING_USERNAME` |
| `handlers/blacklist.py` | add_chat_conv | `WAITING_ADD_CHAT` |
| `handlers/admin.py` | grant_conv | `INPUT_USER_FOR_SUB`, `SELECT_PLAN` |
| `handlers/admin.py` | add_admin_conv | `INPUT_USER_FOR_ADMIN` |
| `handlers/admin.py` | pvz_chats_conv | `INPUT_PVZ_CHATS` |
| `handlers/admin.py` | bl_chats_conv | `INPUT_BLACKLIST_CHATS` |

### –†–µ—à–µ–Ω–∏–µ

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**

#### 1. `conversation_timeout` –Ω–∞ –≤—Å–µ—Ö ConversationHandler (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–∫—Å)

–î–æ–±–∞–≤–∏—Ç—å `conversation_timeout=300` (5 –º–∏–Ω—É—Ç) –∫–æ –í–°–ï–ú ConversationHandler.
–ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

```python
# –í–æ –≤—Å–µ—Ö ConversationHandler:
ConversationHandler(
    entry_points=[...],
    states={...},
    fallbacks=[...],
    conversation_timeout=300,  # 5 –º–∏–Ω—É—Ç –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Üí –∞–≤—Ç–æ-—Å–±—Ä–æ—Å
)
```

**–§–∞–π–ª—ã:**
- `parserhub/handlers/auth.py` ‚Äî `auth_conv`
- `parserhub/handlers/workers.py` ‚Äî `monitoring_conv`
- `parserhub/handlers/realty.py` ‚Äî `parsing_conv`
- `parserhub/handlers/blacklist.py` ‚Äî `check_user_conv`, `add_chat_conv`
- `parserhub/handlers/admin.py` ‚Äî `grant_conv`, `add_admin_conv`, `pvz_chats_conv`, `bl_chats_conv`

#### ~~2. –ü–µ—Ä–µ—Ö–≤–∞—Ç inline-–∫–Ω–æ–ø–æ–∫ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ fallbacks~~ ‚Äî –ù–ï –ù–£–ñ–ù–û

> **–°–Ω—è—Ç–æ:** –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –£–ª—É—á—à–µ–Ω–∏—è #7 (Reply-–Ω–∞–≤–∏–≥–∞—Ü–∏—è) –≤—Å—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏–¥—ë—Ç —á–µ—Ä–µ–∑
> Reply-–∫–Ω–æ–ø–∫–∏ ‚Üí `MAIN_MENU_FILTER` –≤ fallbacks –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç conversation
> –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑–¥–µ–ª. –°–ª–æ–∂–Ω–∞—è —Å—Ö–µ–º–∞ cross-conv fallback —Å `common.py` –Ω–µ –Ω—É–∂–Ω–∞.

#### ~~3. –ó–∞—â–∏—Ç–∞ –æ—Ç "–º—ë—Ä—Ç–≤—ã—Ö" —Å–æ—Å—Ç–æ—è–Ω–∏–π —á–µ—Ä–µ–∑ entry_point –ø—Ä–æ–≤–µ—Ä–∫—É~~ ‚Äî –ù–ï –ù–£–ñ–ù–û

> **–°–Ω—è—Ç–æ:** Reply-–Ω–∞–≤–∏–≥–∞—Ü–∏—è + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `MAIN_MENU_FILTER` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç, —á—Ç–æ –ø—Ä–∏
> –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ —Å—Ç–∞—Ä—ã–π ConversationHandler –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.
> –û—á–∏—Å—Ç–∫–∞ `context.user_data` –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–∞.

---

## –ë–∞–≥ #2: `module 'parserhub.config' has no attribute 'BOT_TOKEN'` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (Avito/Cian) –ø–∞–¥–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: module 'parserhub.config' has no attribute 'BOT_TOKEN'
```

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
–í `parserhub/handlers/realty.py` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç:
```python
from parserhub import config  # ‚Üê –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ú–û–î–£–õ–¨ parserhub.config
```
–ó–∞—Ç–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ `config.BOT_TOKEN` –∏—â–µ—Ç –∞—Ç—Ä–∏–±—É—Ç `BOT_TOKEN` –Ω–∞ **–º–æ–¥—É–ª–µ**, –∞ –Ω–µ –Ω–∞
**—ç–∫–∑–µ–º–ø–ª—è—Ä–µ** –∫–ª–∞—Å—Å–∞ `Config`. –≠–∫–∑–µ–º–ø–ª—è—Ä `config` –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è `parserhub/config.py:46`.

### –†–µ—à–µ–Ω–∏–µ
–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:
```python
from parserhub.config import config  # ‚Üê –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≠–ö–ó–ï–ú–ü–õ–Ø–† config –∏–∑ –º–æ–¥—É–ª—è
```

### –§–∞–π–ª—ã
- `parserhub/handlers/realty.py` ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏–º–ø–æ—Ä—Ç–∞

---

## –ë–∞–≥ #3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ß–° ‚Äî `unable to open database file` + –ª–æ–∂–Ω–æ–µ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä–≤–∞–Ω–∞"

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ß–µ—Ä–Ω–æ–º –°–ø–∏—Å–∫–µ:
```
workers-service  | —Å–µ—Å—Å–∏—è: /app/data/sessions/877195532_blacklist
workers-service  | ERROR | –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –ß–°: unable to open database file
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä–≤–∞–Ω–∞. –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã Telegram."
–ù–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞ –ø—É—Ç–∏ –∫ —Å–µ—Å—Å–∏–∏.

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –¥–≤–∞ –±–∞–≥–∞ –≤ –æ–¥–Ω–æ–º

#### 3a. –ü—É—Ç—å –∫ blacklist-—Å–µ—Å—Å–∏–∏ –∏–∑ PurserHub-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤–º–µ—Å—Ç–æ workers-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

–¢–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞, —á—Ç–æ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è workers handler, –Ω–æ **–ù–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è blacklist handler**.

–í `parserhub/handlers/blacklist.py:127`:
```python
blacklist_session_path = session_mgr.get_session_path(user_id, "blacklist")
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: /app/data/sessions/877195532_blacklist  (–ø—É—Ç—å –≤ PurserHub –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
# –ù—É–∂–Ω–æ:      /app/sessions/877195532_blacklist        (–ø—É—Ç—å –≤ workers –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
```

Workers-service –ø–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å `/app/data/sessions/877195532_blacklist`, –Ω–æ shared volume
—Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ `/app/sessions/` ‚Üí —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí `unable to open database file`.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø—É—Ç—å –¥–ª—è workers-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```python
blacklist_session_path = f"/app/sessions/{user_id}_blacklist"
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –º–µ—Å—Ç–∞ –≤ `parserhub/handlers/blacklist.py`:**
- `receive_username()` —Å—Ç—Ä–æ–∫–∞ 127 ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ß–°
- `receive_add_chat()` —Å—Ç—Ä–æ–∫–∞ 306 ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤ —á–∞—Ç–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏

#### 3b. –õ–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä–≤–∞–Ω–∞" –∏–∑-–∑–∞ —Å–ª–æ–≤–∞ "session" –≤ URL

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏:
```python
if any(keyword in error_msg for keyword in ["authkeyinvalid", "auth", "session", "unauthorized", "—Å–µ—Å—Å–∏—è"]):
```

–ö–æ–≥–¥–∞ workers-service –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500, httpx –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç `HTTPStatusError`. –ú–µ—Ç–æ–¥ `str(e)`
—Å–æ–¥–µ—Ä–∂–∏—Ç URL –∑–∞–ø—Ä–æ—Å–∞:
```
Server error '500 Internal Server Error' for url
'http://workers-service:8002/blacklist/check?...&blacklist_session_path=%2Fapp%2Fdata%2Fsessions%2F...'
```

URL —Å–æ–¥–µ—Ä–∂–∏—Ç `session` –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `blacklist_session_path` ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ª–æ–≤–∏–µ ‚Üí
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä–≤–∞–Ω–∞", —Ö–æ—Ç—è —Ä–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ—Å—Ç–æ—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞, –Ω–µ URL:

```python
# –í–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ str(e) —Ü–µ–ª–∏–∫–æ–º:
if isinstance(e, httpx.HTTPStatusError):
    try:
        detail = e.response.json().get("detail", "").lower()
    except Exception:
        detail = e.response.text.lower()
    is_auth_error = any(kw in detail for kw in ["authkeyinvalid", "unauthorized", "not authorized"])
else:
    is_auth_error = any(kw in str(e).lower() for kw in ["authkeyinvalid", "unauthorized"])
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- `parserhub/handlers/blacklist.py` ‚Äî `receive_username()`, `receive_add_chat()`
- `parserhub/handlers/workers.py` ‚Äî `confirm_start()`
- `parserhub/handlers/realty.py` ‚Äî `confirm_start()`

---

## –ë–∞–≥ #4: Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–í–ó –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ü–∞—Ä—Å–∏–Ω–≥ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ (`‚úì –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ` –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
- **–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è** ‚Äî –Ω–µ—Ç –ª–æ–≥–æ–≤ `[REALTIME] –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ`
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±–æ—Ç –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
- –ò–Ω–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º Telegram)

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (2026-02-15)

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –≤ –æ—Ñ. Telegram** ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ª–æ–≥–∞–º–∏:
   –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ `pvz_zamena` ‚Äî —Å—Ä–∞–∑—É –ø–æ—à–ª–∏ `[REALTIME]` –ª–æ–≥–∏
2. **–ß–∏—Ç–∞–µ—Ç –ù–ï –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –≤—ã–±–æ—Ä–æ—á–Ω–æ** ‚Äî —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ —Ñ–∏–ª—å—Ç—Ä—ã,
   –±—ã–ª–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∫–∏ –Ω–µ—è—Å–Ω–∞ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, Telegram –æ—Ç–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ "–±–ª–∏–∂–∞–π—à–∏–µ"
   –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `getChannelDifference`, –∞ –Ω–µ –≤—Å–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
3. **–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ ‚Äî –ø–æ–ª–Ω–∞—è —Ç–∏—à–∏–Ω–∞** ‚Äî –Ω–∏ –æ–¥–Ω–æ–≥–æ `[REALTIME]` –ª–æ–≥–∞ –∑–∞ —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –Ω–µ–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å MTProto updates –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤/–≥—Ä—É–ø–ø

Pyrogram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MTProto API. –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º
`updates.getChannelDifference`. Pyrogram –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
–∫–∞–Ω–∞–ª–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. **–ù–æ —ç—Ç–æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω:**

1. **Pyrogram –º–æ–∂–µ—Ç "–ø—Ä–æ–ø—É—Å–∫–∞—Ç—å" –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤** ‚Äî –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç
   `getChannelDifference` –≤–æ–≤—Ä–µ–º—è, –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
2. **–û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –≤ –æ—Ñ. Telegram "–ø–∏–Ω–∞–µ—Ç" –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç
   –≤—ã–∑—ã–≤–∞–µ—Ç `readHistory`/sync, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç—å pending updates
   –Ω–∞ –í–°–ï –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è Pyrogram)
3. **`filters.chat()` —Å username —Å—Ç—Ä–æ–∫–∞–º–∏** –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω ‚Äî –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   —á–∏—Å–ª–æ–≤—ã–µ chat_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (parser.py)

```
setup_realtime_handler():
  - filters.chat(["pvz_workers", "pvz_zamena", ...])  # —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ @
  - client.add_handler(MessageHandler(callback, filters=chat_filter))

run_until_stopped():
  - get_dialogs(limit=100)  # –∑–∞–≥—Ä—É–∑–∫–∞ –∫—ç—à–∞
  - while loop –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ is_connected
  - –ü–æ–ª–∞–≥–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ Pyrogram internal update dispatcher
```

### –†–µ—à–µ–Ω–∏–µ ‚Äî –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: real-time handler + polling fallback

#### 1. –†–µ–∑–æ–ª–≤–∏—Ç—å chat_id –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–≤–º–µ—Å—Ç–æ username —Å—Ç—Ä–æ–∫)

```python
# –í setup_realtime_handler():
chat_ids = []
for username in chat_usernames:
    chat = await self.client.get_chat(username)
    chat_ids.append(chat.id)
    logger.info(f"Resolved {username} ‚Üí chat_id={chat.id}")

chat_filter = filters.chat(chat_ids)  # —á–∏—Å–ª–æ–≤—ã–µ ID ‚Äî –Ω–∞–¥—ë–∂–Ω–µ–µ
```

#### 2. –î–æ–±–∞–≤–∏—Ç—å polling fallback –≤ run_until_stopped()

–ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è) ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
—á–µ—Ä–µ–∑ `get_chat_history(limit=5)`. –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ–≤–µ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ
‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö.

```python
# –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ message_id per chat
last_seen_msg_id: Dict[str, int] = {}

async def poll_new_messages(self):
    """Fallback-–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ polling"""
    for chat_username in self.chats:
        try:
            async for msg in self.client.get_chat_history(chat_username, limit=5):
                if not msg.text:
                    continue
                last_id = self.last_seen_msg_id.get(chat_username, 0)
                if msg.id > last_id:
                    await self.message_handler(msg, chat_username)
                    self.last_seen_msg_id[chat_username] = max(
                        msg.id, self.last_seen_msg_id.get(chat_username, 0)
                    )
                else:
                    break  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
        except Exception as e:
            logger.warning(f"Polling fallback –æ—à–∏–±–∫–∞ –¥–ª—è {chat_username}: {e}")
```

–í `run_until_stopped()` –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –≤ —Ü–∏–∫–ª:
```python
except asyncio.TimeoutError:
    if not self.client.is_connected:
        # ... –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    else:
        logger.debug("‚úì –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ")
        # Polling fallback ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        await self.poll_new_messages()
```

#### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å last_seen_msg_id –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—Ä–∏–∏

–ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π message_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞,
—á—Ç–æ–±—ã polling fallback –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

#### 4. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

–ï—Å–ª–∏ real-time handler –ò polling –æ–±–∞ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –Ω—É–∂–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è.
–í `process_message` —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ `content_hash`, –Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
–ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ `message_id + chat_id`:

```python
# –í MonitoringTask.process_message():
msg_key = f"{message.chat.id}:{message.id}"
if msg_key in self.processed_messages:
    return  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
self.processed_messages.add(msg_key)
```

### –§–∞–π–ª—ã
- `workers_service/parser.py` ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
  - `setup_realtime_handler()` ‚Äî —Ä–µ–∑–æ–ª–≤–∏—Ç—å chat_id
  - `run_until_stopped()` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å polling fallback
  - –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `poll_new_messages()`
- `workers_service/tasks.py` ‚Äî `MonitoringTask`:
  - –î–æ–±–∞–≤–∏—Ç—å `last_seen_msg_id` –∏ `processed_messages`
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—Ä–∏–∏
  - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤ `process_message()`

---

## –£–ª—É—á—à–µ–Ω–∏–µ #5: –°–∫—Ä—ã—Ç—å –º–µ–Ω—é "–ü–æ–¥–ø–∏—Å–∫–∞" –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### –û–ø–∏—Å–∞–Ω–∏–µ
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "üí≥ –ü–æ–¥–ø–∏—Å–∫–∞" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é. –û–Ω–∞ –µ–º—É –Ω–µ –Ω—É–∂–Ω–∞ ‚Äî
–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º.

### –†–µ—à–µ–Ω–∏–µ
–í `show_main_menu()` ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–¥–ø–∏—Å–∫–∞" –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω.

```python
# parserhub/handlers/start.py : show_main_menu()
keyboard = [
    [KeyboardButton(MenuButton.ACCOUNT)],
    [KeyboardButton(MenuButton.WORKERS)],
    [KeyboardButton(MenuButton.REALTY)],
    [KeyboardButton(MenuButton.BLACKLIST)],
]

if not await _is_admin(user_id, db):
    keyboard.append([KeyboardButton(MenuButton.SUBSCRIPTION)])

keyboard.append([KeyboardButton(MenuButton.SETTINGS)])
```

### –§–∞–π–ª—ã
- `parserhub/handlers/start.py` ‚Äî `show_main_menu()`: —É—Å–ª–æ–≤–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- `parserhub/handlers/admin.py` ‚Üí `parserhub/handlers/start.py` ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
  —Ñ—É–Ω–∫—Ü–∏—é `_is_admin()`, —Ç.–∫. –æ–Ω–∞ –Ω—É–∂–Ω–∞ –≤ `start.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ `admin.py`

---

## –£–ª—É—á—à–µ–Ω–∏–µ #6: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω –ø–æ–¥–ø–∏—Å–æ–∫

### –û–ø–∏—Å–∞–Ω–∏–µ
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ö–æ—á–µ—Ç –º–µ–Ω—è—Ç—å —Ü–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫ –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

### –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî —Ü–µ–Ω—ã –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ 3 –º–µ—Å—Ç–∞—Ö –∏ –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç!

| –ú–µ—Å—Ç–æ | day | month | quarter |
|-------|-----|-------|---------|
| `SubscriptionService.PLANS` (price) | 30000 (300‚ÇΩ) | 50000 (500‚ÇΩ) | 100000 (1000‚ÇΩ) |
| `buy_subscription()` plans_info | 10000 (100‚ÇΩ) | 50000 (500‚ÇΩ) | 100000 (1000‚ÇΩ) |
| `subscription_keyboard()` —Ç–µ–∫—Å—Ç | "100 RUB" | "500 RUB" | "1000 RUB" |

**Day-–ø–æ–¥–ø–∏—Å–∫–∞:** PLANS –≥–æ–≤–æ—Ä–∏—Ç 300‚ÇΩ, –∏–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 100‚ÇΩ, –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 100‚ÇΩ.

### –†–µ—à–µ–Ω–∏–µ

#### 1. –•—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `global_config`)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É `global_config` —Å –∫–ª—é—á–æ–º `subscription_plans`:

```python
# –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ global_config:
{
    "day":     {"days": 1,  "price": 10000, "label": "1 –¥–µ–Ω—å"},
    "month":   {"days": 30, "price": 50000, "label": "30 –¥–Ω–µ–π"},
    "quarter": {"days": 90, "price": 100000, "label": "90 –¥–Ω–µ–π"}
}
# price –≤ –∫–æ–ø–µ–π–∫–∞—Ö (Telegram Payments —Ñ–æ—Ä–º–∞—Ç)
```

#### 2. SubscriptionService ‚Äî –∑–∞–≥—Ä—É–∂–∞—Ç—å PLANS –∏–∑ –ë–î

```python
class SubscriptionService:
    # PLANS –±–æ–ª—å—à–µ –Ω–µ class constant ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î
    DEFAULT_PLANS = {
        "day": {"days": 1, "price": 10000, "label": "1 –¥–µ–Ω—å"},
        "month": {"days": 30, "price": 50000, "label": "30 –¥–Ω–µ–π"},
        "quarter": {"days": 90, "price": 100000, "label": "90 –¥–Ω–µ–π"},
    }

    async def get_plans(self) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏–∑ –ë–î (—Å fallback –Ω–∞ default)"""
        ...

    async def update_plan_price(self, plan: str, price: int):
        """–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É —Ç–∞—Ä–∏—Ñ–∞ (price –≤ –∫–æ–ø–µ–π–∫–∞—Ö)"""
        ...
```

#### 3. subscription_keyboard() –∏ buy_subscription() ‚Äî —á–∏—Ç–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ –ë–î

–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ‚Äî `SubscriptionService.get_plans()`.

```python
async def subscription_keyboard(service: SubscriptionService):
    plans = await service.get_plans()
    buttons = []
    for key, plan in plans.items():
        price_rub = plan["price"] // 100
        buttons.append([InlineKeyboardButton(
            f"{plan['label']} ‚Äî {price_rub} RUB",
            callback_data=f"buy_{key}"
        )])
    buttons.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="main_menu")])
    return InlineKeyboardMarkup(buttons)
```

#### 4. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏"

–í `parserhub/handlers/admin.py` –¥–æ–±–∞–≤–∏—Ç—å:
- –ö–Ω–æ–ø–∫–∞ "üí∞ –¶–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫" –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é (Reply-–∫–Ω–æ–ø–∫–∞, –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ #7)
- –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
- Reply-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ ‚Üí –≤–≤–æ–¥ –Ω–æ–≤–æ–π —Ü–µ–Ω—ã
- ConversationHandler –¥–ª—è –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)

> **–í–∞–∂–Ω–æ:** –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ü–û–°–õ–ï –£–ª—É—á—à–µ–Ω–∏—è #7, –ø–æ—ç—Ç–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å
> –Ω–∞ Reply-–∫–Ω–æ–ø–∫–∞—Ö, –∞ –Ω–µ –Ω–∞ Inline.

```
–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (Reply keyboard):
  üí∞ –¶–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫  |  üìã –ü–æ–¥–ø–∏—Å–∫–∏
  üéÅ –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É |  üí∞ –î–æ—Ö–æ–¥—ã
  üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã  |  üìù –ß–∞—Ç—ã
  üîô –ù–∞–∑–∞–¥

‚Üì –ù–∞–∂–∞–ª "üí∞ –¶–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫"

  1 –¥–µ–Ω—å: 100‚ÇΩ ‚Äî ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
  30 –¥–Ω–µ–π: 500‚ÇΩ ‚Äî ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
  90 –¥–Ω–µ–π: 1000‚ÇΩ ‚Äî ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
  üîô –ù–∞–∑–∞–¥
```

### –§–∞–π–ª—ã
- `parserhub/services/subscription_service.py` ‚Äî `get_plans()`, `update_plan_price()`, —É–±—Ä–∞—Ç—å hardcoded PLANS
- `parserhub/handlers/subscription.py` ‚Äî `subscription_keyboard()`, `buy_subscription()` —á–∏—Ç–∞—é—Ç –∏–∑ –ë–î
- `parserhub/handlers/admin.py` ‚Äî –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª "–¶–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫"
- `parserhub/db_service.py` ‚Äî –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON –≤ global_config

---

## –£–ª—É—á—à–µ–Ω–∏–µ #7: –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é —Å Inline-–∫–Ω–æ–ø–æ–∫ –Ω–∞ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–°–µ–π—á–∞—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Reply-–∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä "üë∑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–í–ó") –±–æ—Ç
–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** —Å Inline-–∫–Ω–æ–ø–∫–∞–º–∏. –ö–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä –∏ —à–ª—ë—Ç
—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —ç—Ç–∏ inline-—Å–æ–æ–±—â–µ–Ω–∏—è **—É–µ–∑–∂–∞—é—Ç –≤–≤–µ—Ä—Ö** –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö —Ç–µ—Ä—è–µ—Ç.

–¢–∞–∫–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∏–º–∞—Ç—å inline-–∫–Ω–æ–ø–∫–∏ –Ω–∞ **—Ä–∞–∑–Ω—ã—Ö —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö**,
—á—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π.

### –†–µ—à–µ–Ω–∏–µ ‚Äî Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—Å–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ **–≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞** –∏ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

```
–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Reply keyboard):
  üë§ –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç  |  üë∑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–í–ó
  üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å  |  ‚ö´ –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
  üí≥ –ü–æ–¥–ø–∏—Å–∫–∞      |  ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  üîß –ê–¥–º–∏–Ω (–µ—Å–ª–∏ –∞–¥–º–∏–Ω)

‚Üì –ù–∞–∂–∞–ª "üë∑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–í–ó"

–ú–ï–ù–Æ –ü–í–ó (Reply keyboard –ú–ï–ù–Ø–ï–¢–°–Ø):
  üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å  |  üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏
  üîô –ù–∞–∑–∞–¥

‚Üì –ù–∞–∂–∞–ª "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å"

–ù–ê–°–¢–†–û–ô–ö–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê (Reply keyboard):
  üë∑ –†–∞–±–æ—Ç–Ω–∏–∫–∏  |  üè¢ –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏
  ‚ùå –û—Ç–º–µ–Ω–∞

‚Üì –ù–∞–∂–∞–ª "üë∑ –†–∞–±–æ—Ç–Ω–∏–∫–∏", –¥–∞–ª–µ–µ –≤–≤–æ–¥ –¥–∞—Ç/—Ü–µ–Ω...

–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï (Reply keyboard):
  ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å  |  ‚ùå –û—Ç–º–µ–Ω–∞
```

#### –ß—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ Inline-–∫–Ω–æ–ø–∫–∞—Ö

Inline-–∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞–≤–∏—Ç—å **—Ç–æ–ª—å–∫–æ** —Ç–∞–º, –≥–¥–µ Reply –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:
- **–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Å task_id)
- **–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏** (–æ–±–Ω–æ–≤–∏—Ç—å/–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É)
- **–ö–Ω–æ–ø–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö** (check_blacklist, ignore)
- **–ü–ª–∞—Ç—ë–∂–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã** (Telegram Payments)
- **–í—ã–±–æ—Ä —Ç–æ–ø–∏–∫–æ–≤ —Ñ–æ—Ä—É–º–∞** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫)

#### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–ö–∞–∂–¥–æ–µ "–º–µ–Ω—é" ‚Äî —ç—Ç–æ —Å–º–µ–Ω–∞ Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã + —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

```python
async def show_workers_menu(update, context):
    keyboard = ReplyKeyboardMarkup([
        [KeyboardButton("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥")],
        [KeyboardButton("üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏")],
        [KeyboardButton("üîô –ù–∞–∑–∞–¥")],
    ], resize_keyboard=True)

    await update.message.reply_text(
        "üë∑ <b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–í–ó</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard,
        parse_mode="HTML",
    )
```

–û–±—Ä–∞–±–æ—Ç–∫–∞ ‚Äî —á–µ—Ä–µ–∑ `MessageHandler(filters.Regex(...))` –≤–º–µ—Å—Ç–æ `CallbackQueryHandler`.

#### –ë–æ–Ω—É—Å: —Ä–µ—à–∞–µ—Ç –ë–∞–≥ #1 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ü—Ä–∏ Reply-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ `MessageHandler`.
ConversationHandler-—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—è—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ –≤ fallbacks —á–µ—Ä–µ–∑ `MAIN_MENU_FILTER`
(–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!) ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–ª–æ–∂–Ω–∞—è —Å—Ö–µ–º–∞ cross-conv fallback –∏–∑ –ë–∞–≥–∞ #1 **–Ω–µ –Ω—É–∂–Ω–∞** ‚Äî
–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å `MAIN_MENU_FILTER` –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤—Å–µ—Ö –ø–æ–¥–º–µ–Ω—é.

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è |
|------|-------------|
| `handlers/start.py` | `MAIN_MENU_FILTER` —Ä–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–º–µ–Ω—é. `menu_button_handler` ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ |
| `handlers/workers.py` | `show_workers_menu` ‚Üí Reply keyboard. Entry points: `MessageHandler` –≤–º–µ—Å—Ç–æ `CallbackQueryHandler`. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: Reply-–∫–Ω–æ–ø–∫–∏ |
| `handlers/realty.py` | –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ workers |
| `handlers/auth.py` | `show_account_menu` ‚Üí Reply keyboard –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–µ—Å—Å–∏–∏ |
| `handlers/blacklist.py` | `show_blacklist_menu` ‚Üí Reply keyboard |
| `handlers/subscription.py` | –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí Reply keyboard (–∏–Ω–≤–æ–π—Å –æ—Å—Ç–∞—ë—Ç—Å—è inline) |
| `handlers/settings.py` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| `handlers/admin.py` | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí Reply keyboard |

---

## –ë–∞–≥ #8: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ user_id –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏–Ω–∞

### –û–ø–∏—Å–∞–Ω–∏–µ
1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ –¥–≤–∞–∂–¥—ã –≤–Ω–µ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —á–µ–ª–æ–≤–µ–∫–∞.
   –•–æ—Ç—è `INSERT OR IGNORE` –≤ –ë–î –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ
   "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" ‚Äî –º–æ–ª—á–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `OR IGNORE`, –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —É—Å–ø–µ—Ö.
2. **–ù–µ—É–¥–æ–±–Ω—ã–π –≤–≤–æ–¥:** –°–µ–π—á–∞—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É Telegram ID (`877195532`).
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç ID –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ –ª–æ–≥–∏–Ω—É (`@Lus_alex`).

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

#### 8a. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

–í `add_admin_receive_user()` (admin.py:296-314) ‚Äî —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `db.add_admin()` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```python
async def add_admin_receive_user(update, context):
    new_admin_id = int(text)
    db: DatabaseService = context.bot_data["db"]
    await db.add_admin(new_admin_id, added_by=update.effective_user.id)
    await update.message.reply_text(f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {new_admin_id} –¥–æ–±–∞–≤–ª–µ–Ω.")
```
`INSERT OR IGNORE` –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–¥–æ–±–∞–≤–ª–µ–Ω", —Ö–æ—Ç—è –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.

#### 8b. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ user_id –≤–º–µ—Å—Ç–æ @username

–¢–µ–∫—É—â–∏–π –≤–≤–æ–¥: `add_admin_start()` –ø—Ä–æ—Å–∏—Ç "–í–≤–µ–¥–∏—Ç–µ Telegram ID" ‚Üí `add_admin_receive_user()`
–ø–∞—Ä—Å–∏—Ç `int(text)`. –ù—É–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å `@username`, —Ä–µ–∑–æ–ª–≤–∏—Ç—å —á–µ—Ä–µ–∑ Bot API –≤ user_id, –∏
—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î.

### –†–µ—à–µ–Ω–∏–µ

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞

```python
async def add_admin_receive_user(update, context):
    username = text.lstrip("@")

    # –†–µ–∑–æ–ª–≤–∏—Ç—å username ‚Üí user_id —á–µ—Ä–µ–∑ Bot API
    # ... (—Å–º. –Ω–∏–∂–µ)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –∞–¥–º–∏–Ω?
    if new_admin_id == config.ADMIN_ID:
        await update.message.reply_text("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞, —É–∂–µ –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø.")
        return ConversationHandler.END

    if await db.is_admin(new_admin_id):
        await update.message.reply_text("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        return ConversationHandler.END

    await db.add_admin(new_admin_id, added_by=update.effective_user.id)
```

#### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ @username

Telegram Bot API **–Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç** —Ä–µ–∑–æ–ª–≤–∏—Ç—å `@username` –≤ `user_id` –Ω–∞–ø—Ä—è–º—É—é ‚Äî –º–µ—Ç–æ–¥ `getChat`
—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–æ–≤/–∫–∞–Ω–∞–ª–æ–≤/–≥—Ä—É–ø–ø, –Ω–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–Ω–∏–º–∞—Ç—å **–æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞** ‚Äî –∏ `@username`, –∏ —á–∏—Å–ª–æ–≤–æ–π ID:

- **–ß–∏—Å–ª–æ–≤–æ–π ID** ‚Üí —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–∏—Ç—å –≤ –ë–î
- **@username** ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å username, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–æ—Ç–æ–º
  (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `/start`) ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å user_id –≤ —Ç–∞–±–ª–∏—Ü–µ admins

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ø—Ä–æ—â–µ):** –ü–æ–ø—Ä–æ—Å–∏—Ç—å –±—É–¥—É—â–µ–≥–æ –∞–¥–º–∏–Ω–∞ —Å–Ω–∞—á–∞–ª–∞ **–Ω–∞–ø–∏—Å–∞—Ç—å /start –±–æ—Ç—É**,
–∞ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ ID, –∫–æ—Ç–æ—Ä—ã–π –±–æ—Ç –∑–∞–ø–æ–º–Ω–∏—Ç –∏–∑ `/start`. –ò–ª–∏: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `username`
–≤ —Ç–∞–±–ª–∏—Ü—É admins.

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥:**
1. –ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `@username` –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID
2. –ï—Å–ª–∏ `@username` ‚Äî –Ω–∞–π—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `users` (–µ—Å–ª–∏ –±–æ—Ç —É–∂–µ –∑–Ω–∞–µ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–æ–±—â–∏—Ç—å: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @xxx –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –µ–≥–æ –Ω–∞–ø–∏—Å–∞—Ç—å /start –±–æ—Ç—É"
4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–ª—É—á–∏—Ç—å user_id –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ admins

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î:**
- –¢–∞–±–ª–∏—Ü–∞ `users` —É–∂–µ –¥–æ–ª–∂–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç—å `username` –ø—Ä–∏ –∫–∞–∂–¥–æ–º `/start` (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- –í `show_admins()` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `@username` —Ä—è–¥–æ–º —Å user_id (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

> –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ü–û–°–õ–ï –£–ª—É—á—à–µ–Ω–∏—è #7. –ù–∞–≤–∏–≥–∞—Ü–∏—è "–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞" –±—É–¥–µ—Ç —á–µ—Ä–µ–∑
> Reply-–∫–Ω–æ–ø–∫–∏, –∞ –Ω–µ Inline. ConversationHandler –¥–ª—è –≤–≤–æ–¥–∞ @username –æ—Å—Ç–∞—ë—Ç—Å—è,
> –Ω–æ entry_point ‚Äî `MessageHandler` (Reply-–∫–Ω–æ–ø–∫–∞), –Ω–µ `CallbackQueryHandler`.

### –§–∞–π–ª—ã
- `parserhub/handlers/admin.py`:
  - `add_admin_start()` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç: "–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ Telegram ID"
  - `add_admin_receive_user()` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ @username, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞, —Ä–µ–∑–æ–ª–≤ —á–µ—Ä–µ–∑ –ë–î
  - `show_admins()` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å @username —Ä—è–¥–æ–º —Å ID
- `parserhub/db_service.py`:
  - `get_user_by_username(username)` ‚Äî –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ –ø–æ username
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `/start` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç username –≤ —Ç–∞–±–ª–∏—Ü—É users

---

## –ë–∞–≥ #9: (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–£–ª—É—á—à–µ–Ω–∏–µ #7** (Reply-–Ω–∞–≤–∏–≥–∞—Ü–∏—è) ‚Äî –¥–µ–ª–∞—Ç—å –ü–ï–†–í–´–ú, —Ç.–∫. —Å–Ω–∏–º–∞–µ—Ç –ø—É–Ω–∫—Ç—ã 2 –∏ 3 –ë–∞–≥–∞ #1.
   –í–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `MAIN_MENU_FILTER` –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–º–µ–Ω—é.
2. **–ë–∞–≥ #1** (—Ç–æ–ª—å–∫–æ `conversation_timeout`) ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–æ –í–°–ï–ú ConversationHandler (–≤–∫–ª—é—á–∞—è admin.py).
   –ü—É–Ω–∫—Ç—ã 2 –∏ 3 –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ —Å–Ω—è—Ç—ã ‚Äî –∏—Ö –ø–æ–∫—Ä—ã–≤–∞–µ—Ç Reply-–Ω–∞–≤–∏–≥–∞—Ü–∏—è.
3. **–ë–∞–≥ #2** (config import) ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ñ–∏–∫—Å
4. **–ë–∞–≥ #3** (session path + –ª–æ–∂–Ω–∞—è "–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä–≤–∞–Ω–∞") ‚Äî —Ñ–∏–∫—Å –ø—É—Ç–µ–π –∏ error matching
5. **–ë–∞–≥ #4** (real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥) ‚Äî polling fallback
6. **–£–ª—É—á—à–µ–Ω–∏–µ #5** (—Å–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –∞–¥–º–∏–Ω–∞) ‚Äî –ø—Ä–æ—Å—Ç–æ–π —Ñ–∏–∫—Å + –∏–º–ø–æ—Ä—Ç `_is_admin` –≤ start.py
7. **–£–ª—É—á—à–µ–Ω–∏–µ #6** (—Ü–µ–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –ë–î + –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å) ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ Reply-–∫–Ω–æ–ø–∫–∞—Ö
8. **–ë–∞–≥ #8** (–¥—É–±–ª–∏–∫–∞—Ç—ã –∞–¥–º–∏–Ω–æ–≤ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ @username) ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ Reply-–∫–Ω–æ–ø–∫–∞—Ö
